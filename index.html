<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Candidate Reservation</title>
  <!-- Google Font for a modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* Global Styles */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #f1f1f1;
      text-align: center;
      color: #333;
    }
    h1, h2, h3 {
      margin: 20px 0;
    }
    /* Login Form Styles */
    #login-div {
      margin: 50px auto;
      width: 300px;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #login-div input, #login-div select {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      box-sizing: border-box;
    }
    /* User Controls (Change Password & Logout) */
    #user-controls {
      margin: 10px auto;
    }
    #user-controls button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    /* Home Page - Section Circles */
    #section-circles {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .section-item {
      display: inline-block;
      text-align: center;
      cursor: pointer;
    }
    .section-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 3px solid #4CAF50;
      background-size: cover;
      background-position: center;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      font-weight: 700;
    }
    .section-circle:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .section-label {
      margin-top: 8px;
      font-size: 18px;
      font-weight: 500;
    }
    /* Sections – hidden by default */
    .section {
      display: none;
      padding: 30px;
      animation: fadeIn 0.5s;
    }
    .back-button {
      margin: 20px;
      font-size: 18px;
      cursor: pointer;
      color: #2196F3;
      text-decoration: underline;
    }
    /* Candidate Card Style */
    .item-card {
      background: #fff;
      margin: 15px;
      padding: 15px;
      width: 260px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: inline-block;
      text-align: left;
      vertical-align: top;
    }
    /* Fixed 200×200 candidate image with border */
    .item-image {
      width: 200px;
      height: 200px;
      object-fit: cover;
      border: 2px solid #ccc;
      border-radius: 8px;
      display: block;
      margin: 0 auto;
    }
    .reserve-button {
      margin-top: 10px;
      padding: 10px;
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      font-weight: 500;
    }
    .reserve-button:hover {
      background: #45a049;
    }
    .reserve-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* Panels: Admin Panel, Change Password, Candidate Management Panel */
    #admin-panel, #change-password-panel, #candidate-panel {
      background: #fff;
      padding: 30px;
      margin: 20px auto;
      width: 80%;
      max-width: 600px;
      text-align: left;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #admin-panel form input,
    #change-password-panel form input,
    #admin-panel form select,
    #candidate-panel form input,
    #candidate-panel form select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 10px;
      box-sizing: border-box;
    }
    #admin-panel form button,
    #change-password-panel form button,
    #candidate-panel form button {
      padding: 8px 12px;
      cursor: pointer;
    }
    .user-entry {
      padding: 5px;
      border-bottom: 1px dashed #ccc;
      margin-bottom: 5px;
    }
    .user-entry button {
      margin-left: 5px;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="login-div">
    <h1>Login</h1>
    <form id="login-form">
      <label for="role">Select Role:</label>
      <select id="role">
        <option value="administrator">Administrator</option>
        <option value="maidmanager">Maid Manager</option>
        <option value="marketer">Marketer</option>
      </select>
      <label for="username">Username:</label>
      <input type="text" id="username" required />
      <label for="password">Password:</label>
      <input type="password" id="password" required />
      <button type="submit">Login</button>
      <p id="login-error" style="color: red;"></p>
    </form>
  </div>
  <!-- Home Page -->
  <div id="home" style="display: none;">
    <h1>Welcome to Our Candidate Reservation Site</h1>
    <!-- User Controls (Change Password & Logout) -->
    <div id="user-controls">
      <button id="change-password-button" onclick="showChangePasswordPanel()">Change Password</button>
      <button id="logout-button" onclick="logout()">Logout</button>
    </div>
    <!-- Section Circles (Country Sections + Management + Reserved) -->
    <div id="section-circles">
      <!-- Country Sections -->
      <div class="section-item" onclick="openSection('section1')">
        <div class="section-circle" style="background-image: url('https://flagcdn.com/w320/lk.png');"></div>
        <div class="section-label">Sri Lanka</div>
      </div>
      <div class="section-item" onclick="openSection('section2')">
        <div class="section-circle" style="background-image: url('https://flagcdn.com/w320/np.png');"></div>
        <div class="section-label">Nepal</div>
      </div>
      <div class="section-item" onclick="openSection('section3')">
        <div class="section-circle" style="background-image: url('https://flagcdn.com/w320/in.png');"></div>
        <div class="section-label">India</div>
      </div>
      <div class="section-item" onclick="openSection('section4')">
        <div class="section-circle" style="background-image: url('https://flagcdn.com/w320/za.png');"></div>
        <div class="section-label">Africa</div>
      </div>
      <div class="section-item" onclick="openSection('section5')">
        <div class="section-circle" style="background-image: url('https://flagcdn.com/w320/ph.png');"></div>
        <div class="section-label">Philippines</div>
      </div>
      <!-- Management Circles -->
      <div id="user-management-section" class="section-item" onclick="showAdminPanel()">
        <div class="section-circle" style="background-color: #ffc107;">UM</div>
        <div class="section-label">User Management</div>
      </div>
      <div id="candidate-management-section" class="section-item" onclick="showCandidatePanel()">
        <div class="section-circle" style="background-color: #17a2b8;">CM</div>
        <div class="section-label">Candidate Management</div>
      </div>
      <!-- Reserved Candidates Circle -->
      <div class="section-item" onclick="openReservedSection()">
        <div class="section-circle" style="background-color: #9c27b0;">RES</div>
        <div class="section-label">Reserved</div>
      </div>
    </div>
  </div>
  <!-- Candidate Sections (Dynamically Loaded by Country) -->
  <!-- Section 1: Sri Lanka Candidates -->
  <div id="section1" class="section">
    <div class="back-button" onclick="goHome()">← Back</div>
    <h2>Sri Lanka Candidates</h2>
    <div id="candidates-sri-lanka"></div>
  </div>
  <!-- Section 2: Nepal Candidates -->
  <div id="section2" class="section">
    <div class="back-button" onclick="goHome()">← Back</div>
    <h2>Nepal Candidates</h2>
    <div id="candidates-nepal"></div>
  </div>
  <!-- Section 3: India Candidates -->
  <div id="section3" class="section">
    <div class="back-button" onclick="goHome()">← Back</div>
    <h2>India Candidates</h2>
    <div id="candidates-india"></div>
  </div>
  <!-- Section 4: Africa Candidates (Empty) -->
  <div id="section4" class="section">
    <div class="back-button" onclick="goHome()">← Back</div>
    <h2>Africa Candidates</h2>
    <div id="candidates-africa"><p>No candidates available in this section.</p></div>
  </div>
  <!-- Section 5: Philippines Candidates (Empty) -->
  <div id="section5" class="section">
    <div class="back-button" onclick="goHome()">← Back</div>
    <h2>Philippines Candidates</h2>
    <div id="candidates-philippines"><p>No candidates available in this section.</p></div>
  </div>
  <!-- Reserved Candidates Section (Independent) -->
  <div id="reserved-section-div" class="section">
    <div class="back-button" onclick="goHome()">← Back</div>
    <h2>Reserved Candidates</h2>
    <div id="reserved-candidates-container"></div>
  </div>
  <!-- Admin Panel (User Management) -->
  <div id="admin-panel" style="display:none;">
    <h2>Admin Panel - Manage Users</h2>
    <!-- Form to add new user -->
    <form id="add-user-form">
      <label>Username:</label>
      <input type="text" id="new-username" required />
      <label>Role:</label>
      <select id="new-role">
        <option value="administrator">Administrator</option>
        <option value="maidmanager">Maid Manager</option>
        <option value="marketer">Marketer</option>
      </select>
      <label>Password:</label>
      <input type="password" id="new-password" required />
      <button type="submit">Add User</button>
      <p id="add-user-error" style="color: red;"></p>
      <p id="add-user-success" style="color: green;"></p>
    </form>
    <hr/>
    <h3>Existing Users</h3>
    <div id="users-list"></div>
    <button onclick="hideAdminPanel()">Close Admin Panel</button>
  </div>
  <!-- Change Password Panel (for all logged in users) -->
  <div id="change-password-panel" style="display:none;">
    <h2>Change Your Password</h2>
    <form id="change-password-form">
      <label>Current Password:</label>
      <input type="password" id="current-password" required />
      <label>New Password:</label>
      <input type="password" id="new-user-password" required />
      <label>Confirm New Password:</label>
      <input type="password" id="confirm-new-password" required />
      <button type="submit">Update Password</button>
      <p id="change-password-error" style="color: red;"></p>
      <p id="change-password-success" style="color: green;"></p>
    </form>
    <button onclick="hideChangePasswordPanel()">Close</button>
  </div>
  <!-- Candidate Management Panel -->
  <div id="candidate-panel" style="display:none;">
    <h2>Manage Candidates</h2>
    <form id="add-candidate-form">
      <label for="candidate-country">Country:</label>
      <select id="candidate-country" required>
        <option value="Sri Lanka">Sri Lanka</option>
        <option value="Nepal">Nepal</option>
        <option value="India">India</option>
        <option value="Africa">Africa</option>
        <option value="Philippines">Philippines</option>
      </select>
      <label for="candidate-age">Age:</label>
      <input type="text" id="candidate-age" required />
      <label for="candidate-experience">Experience &amp; Details:</label>
      <input type="text" id="candidate-experience" required />
      <label for="candidate-languages">Languages:</label>
      <input type="text" id="candidate-languages" required />
      <label for="candidate-skills">Skills:</label>
      <input type="text" id="candidate-skills" required />
      <label for="candidate-secretary">Secretary In Charge:</label>
      <input type="text" id="candidate-secretary" required />
      <label for="candidate-image">Candidate Image:</label>
      <input type="file" id="candidate-image" accept="image/*" required />
      <button type="submit">Add Candidate</button>
      <p id="candidate-add-error" style="color:red;"></p>
      <p id="candidate-add-success" style="color:green;"></p>
    </form>
    <hr/>
    <h3>Existing Candidates (All)</h3>
    <div id="candidates-list"></div>
    <button onclick="hideCandidatePanel()">Close Panel</button>
  </div>
  <!-- Firebase & Navigation Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDocs,
      collection,
      getDoc,
      updateDoc,
      deleteDoc,
      addDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    // Firebase configuration details
    const firebaseConfig = {
      apiKey: "AIzaSyBa2i6Dv-Wi5KAUe91DeNL5U9L--HZkni0",
      authDomain: "fursatkum-792e8.firebaseapp.com",
      projectId: "fursatkum-792e8",
      storageBucket: "fursatkum-792e8.firebasestorage.app",
      messagingSenderId: "275915365900",
      appId: "1:275915365900:web:b365e63d2da8cbd3691829",
      measurementId: "G-FLSGFE2QYV"
    };
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    // Global variable to store current user details
    window.currentUser = null;
    // Ensure default administrator exists on load
    async function ensureAdminExists() {
      const adminRef = doc(db, "users", "Andrew");
      const adminSnap = await getDoc(adminRef);
      if (!adminSnap.exists()) {
        await setDoc(adminRef, { username: "Andrew", role: "administrator", password: "ROBENHOOD" });
      }
    }
    // Login functionality – using Firestore users collection
    document.getElementById("login-form").addEventListener("submit", async function(event) {
      event.preventDefault();
      const role = document.getElementById("role").value;
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const loginError = document.getElementById("login-error");
      const userDocRef = doc(db, "users", username);
      const userDocSnap = await getDoc(userDocRef);
      if (!userDocSnap.exists()) {
        loginError.innerText = "User not found.";
        return;
      }
      const userData = userDocSnap.data();
      if (userData.password !== password || userData.role !== role) {
        loginError.innerText = "Invalid credentials.";
        return;
      }
      // Successful login
      window.currentUser = { username, role, password };
      document.getElementById("login-div").style.display = "none";
      document.getElementById("home").style.display = "block";
      loginError.innerText = "";
      // Show management circles only for authorized roles
      if (role === "administrator") {
        document.getElementById("user-management-section").style.display = "inline-block";
      } else {
        document.getElementById("user-management-section").style.display = "none";
      }
      if (role === "administrator" || role === "maidmanager") {
        document.getElementById("candidate-management-section").style.display = "inline-block";
      } else {
        document.getElementById("candidate-management-section").style.display = "none";
      }
    });
    // Logout functionality
    window.logout = function() {
      window.currentUser = null;
      document.getElementById("home").style.display = "none";
      document.getElementById("login-div").style.display = "block";
      document.getElementById("admin-panel").style.display = "none";
      document.getElementById("change-password-panel").style.display = "none";
      document.getElementById("candidate-panel").style.display = "none";
    };
    // Navigation Functions
    window.goHome = function() {
      const sections = document.getElementsByClassName('section');
      for (let sec of sections) { sec.style.display = 'none'; }
      document.getElementById('home').style.display = 'block';
    };
    window.openSection = function(sectionId) {
      document.getElementById('home').style.display = 'none';
      const sections = document.getElementsByClassName('section');
      for (let sec of sections) { sec.style.display = 'none'; }
      document.getElementById(sectionId).style.display = 'block';
      // Load candidates for the appropriate country section
      if (sectionId === "section1") {
        loadCandidatesForSection("Sri Lanka", "candidates-sri-lanka");
      } else if (sectionId === "section2") {
        loadCandidatesForSection("Nepal", "candidates-nepal");
      } else if (sectionId === "section3") {
        loadCandidatesForSection("India", "candidates-india");
      } else if (sectionId === "section4") {
        loadCandidatesForSection("Africa", "candidates-africa");
      } else if (sectionId === "section5") {
        loadCandidatesForSection("Philippines", "candidates-philippines");
      }
    };
    // Open Reserved Candidates Section
    window.openReservedSection = function() {
      document.getElementById('home').style.display = 'none';
      const sections = document.getElementsByClassName('section');
      for (let sec of sections) { sec.style.display = 'none'; }
      document.getElementById("reserved-section-div").style.display = "block";
      loadReservedCandidates();
    };
    // ----------------------------- 
    // Candidate Listing and Editing Functions
    // -----------------------------
    // Load candidates for a given country (only unreserved ones)
    async function loadCandidatesForSection(country, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      try {
        const q = query(collection(db, "candidates"), where("country", "==", country));
        const querySnapshot = await getDocs(q);
        // Load reservation status for each candidate
        const resSnapshot = await getDocs(collection(db, "reservations"));
        const reservedMap = {};
        resSnapshot.forEach(resDoc => { reservedMap[resDoc.id] = resDoc.data(); });
        if (querySnapshot.empty) {
          container.innerHTML = "<p>No candidates available in this section.</p>";
          return;
        }
        querySnapshot.forEach(docSnap => {
          const candidate = docSnap.data();
          const candidateId = docSnap.id;
          // Skip candidate if reserved
          if (reservedMap[candidateId]) return;
          const card = document.createElement('div');
          card.className = 'item-card';
          card.innerHTML = `
            <img src="${candidate.imageUrl}" alt="Candidate Image" class="item-image">
            <p>
              <strong>Age:</strong> ${candidate.age}<br>
              <strong>Experience:</strong> ${candidate.experience}<br>
              <strong>Languages:</strong> ${candidate.languages}<br>
              <strong>Skills:</strong> ${candidate.skills}<br>
              <strong>Secretary In Charge:</strong> ${candidate.secretaryInCharge || ""}
            </p>
          `;
          // Add Reserve button
          const reserveBtn = document.createElement("button");
          reserveBtn.innerText = "Reserve";
          reserveBtn.className = "reserve-button";
          reserveBtn.onclick = function() { reserveCandidate(candidateId, country, containerId); };
          card.appendChild(reserveBtn);
          // If authorized, add Delete and Edit buttons
          if (window.currentUser && (window.currentUser.role === "administrator" || window.currentUser.role === "maidmanager")) {
            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "Delete";
            deleteBtn.style.backgroundColor = "red";
            deleteBtn.style.color = "#fff";
            deleteBtn.style.border = "none";
            deleteBtn.style.padding = "8px 12px";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.style.marginTop = "10px";
            deleteBtn.onclick = function() { deleteCandidate(candidateId, containerId, country); };
            card.appendChild(deleteBtn);
            // Edit Button and hidden form for editing candidate info
            const editBtn = document.createElement("button");
            editBtn.innerText = "Edit";
            editBtn.style.backgroundColor = "#2196F3";
            editBtn.style.color = "#fff";
            editBtn.style.border = "none";
            editBtn.style.padding = "8px 12px";
            editBtn.style.cursor = "pointer";
            editBtn.style.marginTop = "10px";
            editBtn.onclick = function() { toggleEditForm(candidateId); };
            card.appendChild(editBtn);
            const editFormDiv = document.createElement("div");
            editFormDiv.id = "edit-form-" + candidateId;
            editFormDiv.style.display = "none";
            editFormDiv.innerHTML = `
              <input type="text" id="edit-age-${candidateId}" placeholder="Age" value="${candidate.age}" /><br>
              <input type="text" id="edit-exp-${candidateId}" placeholder="Experience" value="${candidate.experience}" /><br>
              <input type="text" id="edit-lang-${candidateId}" placeholder="Languages" value="${candidate.languages}" /><br>
              <input type="text" id="edit-skill-${candidateId}" placeholder="Skills" value="${candidate.skills}" /><br>
              <input type="text" id="edit-sec-${candidateId}" placeholder="Secretary In Charge" value="${candidate.secretaryInCharge || ''}" /><br>
              <button onclick="updateCandidate('${candidateId}', '${candidate.country}', 'normal')">Save</button>
              <button onclick="cancelEditCandidate('${candidateId}')">Cancel</button>
            `;
            card.appendChild(editFormDiv);
          }
          container.appendChild(card);
        });
      } catch (err) {
        console.error("Error loading candidates for section:", err);
      }
    }
    // Load reserved candidates for Reserved section
    async function loadReservedCandidates() {
      const container = document.getElementById("reserved-candidates-container");
      container.innerHTML = "";
      try {
        const resSnapshot = await getDocs(collection(db, "reservations"));
        let reservedList = [];
        resSnapshot.forEach(docSnap => {
          const resData = docSnap.data();
          if (window.currentUser.role !== "administrator") {
            if (resData.reservedBy === window.currentUser.username) {
              reservedList.push({ candidateId: docSnap.id, ...resData });
            }
          } else {
            reservedList.push({ candidateId: docSnap.id, ...resData });
          }
        });
        if (reservedList.length === 0) {
          container.innerHTML = "<p>No reserved candidates available.</p>";
          return;
        }
        for (const reservation of reservedList) {
          const candidateDoc = await getDoc(doc(db, "candidates", reservation.candidateId));
          if (candidateDoc.exists()) {
            const candidate = candidateDoc.data();
            const candidateId = reservation.candidateId;
            const card = document.createElement('div');
            card.className = 'item-card';
            let extraInfo = "";
            if (window.currentUser.role === "administrator") {
              extraInfo = `<em>Reserved by: ${reservation.reservedBy}</em><br>`;
            }
            card.innerHTML = `
              <img src="${candidate.imageUrl}" alt="Candidate Image" class="item-image">
              <p>
                <strong>Age:</strong> ${candidate.age}<br>
                <strong>Experience:</strong> ${candidate.experience}<br>
                <strong>Languages:</strong> ${candidate.languages}<br>
                <strong>Skills:</strong> ${candidate.skills}<br>
                <strong>Secretary In Charge:</strong> ${candidate.secretaryInCharge || ""}<br>
                ${extraInfo}
              </p>
            `;
            if (window.currentUser.role === "administrator" || reservation.reservedBy === window.currentUser.username) {
              const cancelReserveBtn = document.createElement("button");
              cancelReserveBtn.innerText = "Cancel Reservation";
              cancelReserveBtn.className = "reserve-button";
              cancelReserveBtn.style.backgroundColor = "#f44336";
              cancelReserveBtn.onclick = function() { cancelReservation(candidateId, null, "reserved-candidates-container", true); };
              card.appendChild(cancelReserveBtn);
            }
            if (window.currentUser && (window.currentUser.role === "administrator" || window.currentUser.role === "maidmanager")) {
              const editBtn = document.createElement("button");
              editBtn.innerText = "Edit";
              editBtn.style.backgroundColor = "#2196F3";
              editBtn.style.color = "#fff";
              editBtn.style.border = "none";
              editBtn.style.padding = "8px 12px";
              editBtn.style.cursor = "pointer";
              editBtn.style.marginTop = "10px";
              editBtn.onclick = function() { toggleEditForm(candidateId); };
              card.appendChild(editBtn);
              const editFormDiv = document.createElement("div");
              editFormDiv.id = "edit-form-" + candidateId;
              editFormDiv.style.display = "none";
              editFormDiv.innerHTML = `
                <input type="text" id="edit-age-${candidateId}" placeholder="Age" value="${candidate.age}" /><br>
                <input type="text" id="edit-exp-${candidateId}" placeholder="Experience" value="${candidate.experience}" /><br>
                <input type="text" id="edit-lang-${candidateId}" placeholder="Languages" value="${candidate.languages}" /><br>
                <input type="text" id="edit-skill-${candidateId}" placeholder="Skills" value="${candidate.skills}" /><br>
                <input type="text" id="edit-sec-${candidateId}" placeholder="Secretary In Charge" value="${candidate.secretaryInCharge || ''}" /><br>
                <button onclick="updateCandidate('${candidateId}', '${candidate.country}', 'reserved')">Save</button>
                <button onclick="cancelEditCandidate('${candidateId}')">Cancel</button>
              `;
              card.appendChild(editFormDiv);
            }
            container.appendChild(card);
          }
        }
      } catch (err) {
        console.error("Error loading reserved candidates:", err);
      }
    }
    // Reserve a candidate by adding a document in "reservations"
    async function reserveCandidate(candidateId, country, containerId) {
      try {
        await setDoc(doc(db, "reservations", candidateId), { reserved: true, reservedBy: window.currentUser.username });
        loadCandidatesForSection(country, containerId);
      } catch (err) {
        console.error("Error reserving candidate:", err);
        alert("Error reserving candidate.");
      }
    }
    // Cancel a reservation
    async function cancelReservation(candidateId, country, containerId, reservedMode = false) {
      try {
        await deleteDoc(doc(db, "reservations", candidateId));
        if (reservedMode) {
          loadReservedCandidates();
        } else {
          loadCandidatesForSection(country, containerId);
        }
      } catch (err) {
        console.error("Error cancelling reservation:", err);
        alert("Error cancelling reservation.");
      }
    }
    // Delete candidate & associated reservation
    window.deleteCandidate = async function(candidateId, containerId, country) {
      if (confirm("Are you sure you want to delete this candidate?")) {
        try {
          await deleteDoc(doc(db, "candidates", candidateId));
          await deleteDoc(doc(db, "reservations", candidateId));
          loadCandidatesForSection(country, containerId);
        } catch (err) {
          console.error("Error deleting candidate:", err);
        }
      }
    };
    // -----------------------------
    // Candidate Editing Functions
    // -----------------------------
    window.toggleEditForm = function(candidateId) {
      const formDiv = document.getElementById("edit-form-" + candidateId);
      formDiv.style.display = (formDiv.style.display === "none" || formDiv.style.display === "") ? "block" : "none";
    };
    window.cancelEditCandidate = function(candidateId) {
      document.getElementById("edit-form-" + candidateId).style.display = "none";
    };
    window.updateCandidate = async function(candidateId, country, context) {
      const updatedAge = document.getElementById(`edit-age-${candidateId}`).value;
      const updatedExp = document.getElementById(`edit-exp-${candidateId}`).value;
      const updatedLang = document.getElementById(`edit-lang-${candidateId}`).value;
      const updatedSkill = document.getElementById(`edit-skill-${candidateId}`).value;
      const updatedSec = document.getElementById(`edit-sec-${candidateId}`).value;
      try {
        await updateDoc(doc(db, "candidates", candidateId), {
          age: updatedAge,
          experience: updatedExp,
          languages: updatedLang,
          skills: updatedSkill,
          secretaryInCharge: updatedSec
        });
        document.getElementById("edit-form-" + candidateId).style.display = "none";
        if (context === "reserved") {
          loadReservedCandidates();
        } else {
          let containerId = "";
          const c = country.toLowerCase();
          if (c === "sri lanka") containerId = "candidates-sri-lanka";
          else if (c === "nepal") containerId = "candidates-nepal";
          else if (c === "india") containerId = "candidates-india";
          else if (c === "africa") containerId = "candidates-africa";
          else if (c === "philippines") containerId = "candidates-philippines";
          loadCandidatesForSection(country, containerId);
        }
      } catch (err) {
        console.error("Error updating candidate:", err);
        alert("Error updating candidate.");
      }
    };
    // -----------------------------
    // Admin Panel (User Management) Functions
    // -----------------------------
    window.showAdminPanel = function() {
      document.getElementById("admin-panel").style.display = "block";
      loadUsersList();
    };
    window.hideAdminPanel = function() {
      document.getElementById("admin-panel").style.display = "none";
    };
    document.getElementById("add-user-form").addEventListener("submit", async function(event) {
      event.preventDefault();
      const newUsername = document.getElementById("new-username").value.trim();
      const newRole = document.getElementById("new-role").value;
      const newPassword = document.getElementById("new-password").value;
      const addUserError = document.getElementById("add-user-error");
      const addUserSuccess = document.getElementById("add-user-success");
      const userRef = doc(db, "users", newUsername);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        addUserError.innerText = "User already exists.";
        addUserSuccess.innerText = "";
        return;
      }
      try {
        await setDoc(userRef, { username: newUsername, role: newRole, password: newPassword });
        addUserSuccess.innerText = "User added successfully.";
        addUserError.innerText = "";
        document.getElementById("new-username").value = "";
        document.getElementById("new-password").value = "";
        loadUsersList();
      } catch (error) {
        addUserError.innerText = "Error adding user.";
        addUserSuccess.innerText = "";
        console.error("Error:", error);
      }
    });
    async function loadUsersList() {
      const usersListDiv = document.getElementById("users-list");
      usersListDiv.innerHTML = "";
      try {
        const querySnapshot = await getDocs(collection(db, "users"));
        querySnapshot.forEach(docSnap => {
          const user = docSnap.data();
          const userDiv = document.createElement("div");
          userDiv.className = "user-entry";
          userDiv.innerHTML = `<strong>${user.username}</strong> (${user.role})
            <button onclick="toggleChangePasswordForm('${user.username}')">Change Password</button>
            <button onclick="toggleEditRoleForm('${user.username}', '${user.role}')">Edit Role</button>
            <button onclick="deleteUser('${user.username}')">Delete User</button>
            <div id="change-form-${user.username}" style="display:none; margin-top: 5px;">
              <input type="password" id="new-pass-${user.username}" placeholder="New Password" />
              <button onclick="updateUserPassword('${user.username}')">Update Password</button>
              <span id="update-result-${user.username}"></span>
            </div>
            <div id="edit-form-${user.username}" style="display:none; margin-top: 5px;">
              <select id="edit-role-${user.username}">
                <option value="administrator">Administrator</option>
                <option value="maidmanager">Maid Manager</option>
                <option value="marketer">Marketer</option>
              </select>
              <button onclick="updateUserRole('${user.username}')">Update Role</button>
              <span id="update-role-result-${user.username}"></span>
            </div>`;
          usersListDiv.appendChild(userDiv);
        });
      } catch (error) {
        console.error("Error loading users:", error);
      }
    }
    window.toggleChangePasswordForm = function(username) {
      const formDiv = document.getElementById("change-form-" + username);
      formDiv.style.display = (formDiv.style.display === "none" || formDiv.style.display === "") ? "block" : "none";
    };
    window.toggleEditRoleForm = function(username, currentRole) {
      const formDiv = document.getElementById("edit-form-" + username);
      if (formDiv.style.display === "none" || formDiv.style.display === "") {
        formDiv.style.display = "block";
        document.getElementById("edit-role-" + username).value = currentRole;
      } else {
        formDiv.style.display = "none";
      }
    };
    window.updateUserPassword = async function(username) {
      const newPassInput = document.getElementById("new-pass-" + username);
      const newPassword = newPassInput.value;
      const resultSpan = document.getElementById("update-result-" + username);
      if (!newPassword) {
        resultSpan.innerText = "Enter a new password.";
        return;
      }
      try {
        const userRef = doc(db, "users", username);
        await updateDoc(userRef, { password: newPassword });
        resultSpan.style.color = "green";
        resultSpan.innerText = "Updated successfully.";
      } catch (error) {
        resultSpan.style.color = "red";
        resultSpan.innerText = "Error updating.";
        console.error("Error:", error);
      }
    };
    window.updateUserRole = async function(username) {
      const newRole = document.getElementById("edit-role-" + username).value;
      const resultSpan = document.getElementById("update-role-result-" + username);
      try {
        const userRef = doc(db, "users", username);
        await updateDoc(userRef, { role: newRole });
        resultSpan.style.color = "green";
        resultSpan.innerText = "Updated successfully.";
        loadUsersList();
      } catch (error) {
        resultSpan.style.color = "red";
        resultSpan.innerText = "Error updating.";
        console.error("Error:", error);
      }
    };
    window.deleteUser = async function(username) {
      if (confirm("Are you sure you want to delete this user?")) {
        try {
          await deleteDoc(doc(db, "users", username));
          loadUsersList();
        } catch (error) {
          console.error("Error deleting user:", error);
        }
      }
    };
    // -----------------------------
    // Change Password (Self-Service)
    // -----------------------------
    window.showChangePasswordPanel = function() {
      document.getElementById("change-password-panel").style.display = "block";
    };
    window.hideChangePasswordPanel = function() {
      document.getElementById("change-password-panel").style.display = "none";
    };
    document.getElementById("change-password-form").addEventListener("submit", async function(event) {
      event.preventDefault();
      const currentPass = document.getElementById("current-password").value;
      const newPass = document.getElementById("new-user-password").value;
      const confirmPass = document.getElementById("confirm-new-password").value;
      const errorMsg = document.getElementById("change-password-error");
      const successMsg = document.getElementById("change-password-success");
      if (!window.currentUser || currentPass !== window.currentUser.password) {
        errorMsg.innerText = "Current password is incorrect.";
        successMsg.innerText = "";
        return;
      }
      if (newPass !== confirmPass) {
        errorMsg.innerText = "New password and confirm password do not match.";
        successMsg.innerText = "";
        return;
      }
      try {
        const userRef = doc(db, "users", window.currentUser.username);
        await updateDoc(userRef, { password: newPass });
        window.currentUser.password = newPass;
        errorMsg.innerText = "";
        successMsg.innerText = "Password updated successfully.";
        document.getElementById("current-password").value = "";
        document.getElementById("new-user-password").value = "";
        document.getElementById("confirm-new-password").value = "";
      } catch (error) {
        errorMsg.innerText = "Error updating password.";
        successMsg.innerText = "";
        console.error("Error:", error);
      }
    });
    // -----------------------------
    // Candidate Management Panel (Adding Candidates)
    // -----------------------------
    window.showCandidatePanel = function() {
      document.getElementById("candidate-panel").style.display = "block";
      loadAllCandidates();
    };
    window.hideCandidatePanel = function() {
      document.getElementById("candidate-panel").style.display = "none";
    };
    // Upload image to Imgur using the provided Client-ID
    async function uploadImageToImgur(file) {
      const formData = new FormData();
      formData.append('image', file);
      try {
        const response = await fetch('https://api.imgur.com/3/image', {
          method: 'POST',
          headers: { Authorization: 'Client-ID 96ba14b0ef97c48' },
          body: formData
        });
        const data = await response.json();
        if (data.success) {
          return data.data.link;
        } else {
          throw new Error("Imgur upload failed");
        }
      } catch (err) {
        console.error(err);
        throw err;
      }
    }
    // Candidate Add Form
    document.getElementById("add-candidate-form").addEventListener("submit", async function(event) {
      event.preventDefault();
      const country = document.getElementById("candidate-country").value;
      const age = document.getElementById("candidate-age").value;
      const experience = document.getElementById("candidate-experience").value;
      const languages = document.getElementById("candidate-languages").value;
      const skills = document.getElementById("candidate-skills").value;
      const secretary = document.getElementById("candidate-secretary").value;
      const imageFile = document.getElementById("candidate-image").files[0];
      const errorElem = document.getElementById("candidate-add-error");
      const successElem = document.getElementById("candidate-add-success");
      errorElem.innerText = "";
      successElem.innerText = "";
      try {
        if (!imageFile) {
          errorElem.innerText = "Please select an image file.";
          return;
        }
        const imageUrl = await uploadImageToImgur(imageFile);
        await addDoc(collection(db, "candidates"), {
          country,
          age,
          experience,
          languages,
          skills,
          secretaryInCharge: secretary,
          imageUrl,
          timestamp: Date.now()
        });
        successElem.innerText = "Candidate added successfully.";
        document.getElementById("candidate-age").value = "";
        document.getElementById("candidate-experience").value = "";
        document.getElementById("candidate-languages").value = "";
        document.getElementById("candidate-skills").value = "";
        document.getElementById("candidate-secretary").value = "";
        document.getElementById("candidate-image").value = "";
        loadAllCandidates();
      } catch (e) {
        errorElem.innerText = "Error adding candidate.";
        console.error(e);
      }
    });
    // Load all candidates for the Candidate Management Panel
    async function loadAllCandidates() {
      const candidatesListDiv = document.getElementById("candidates-list");
      candidatesListDiv.innerHTML = "";
      try {
        const querySnapshot = await getDocs(collection(db, "candidates"));
        querySnapshot.forEach(docSnap => {
          const candidate = docSnap.data();
          const candidateId = docSnap.id;
          const candidateDiv = document.createElement("div");
          candidateDiv.className = "item-card";
          candidateDiv.innerHTML = `
            <img src="${candidate.imageUrl}" alt="Candidate Image" class="item-image">
            <p>
              <strong>Age:</strong> ${candidate.age}<br>
              <strong>Country:</strong> ${candidate.country}<br>
              <strong>Experience:</strong> ${candidate.experience}<br>
              <strong>Languages:</strong> ${candidate.languages}<br>
              <strong>Skills:</strong> ${candidate.skills}<br>
              <strong>Secretary In Charge:</strong> ${candidate.secretaryInCharge || ""}
            </p>
          `;
          if (window.currentUser && (window.currentUser.role === "administrator" || window.currentUser.role === "maidmanager")) {
            const delButton = document.createElement("button");
            delButton.innerText = "Delete";
            delButton.style.backgroundColor = "red";
            delButton.style.color = "#fff";
            delButton.style.border = "none";
            delButton.style.padding = "8px 12px";
            delButton.style.cursor = "pointer";
            delButton.style.marginTop = "10px";
            delButton.onclick = function() {
              deleteCandidate(candidateId);
              loadAllCandidates();
            };
            candidateDiv.appendChild(delButton);
            const editBtn = document.createElement("button");
            editBtn.innerText = "Edit";
            editBtn.style.backgroundColor = "#2196F3";
            editBtn.style.color = "#fff";
            editBtn.style.border = "none";
            editBtn.style.padding = "8px 12px";
            editBtn.style.cursor = "pointer";
            editBtn.style.marginTop = "10px";
            editBtn.onclick = function() { toggleEditForm(candidateId); };
            candidateDiv.appendChild(editBtn);
            const editFormDiv = document.createElement("div");
            editFormDiv.id = "edit-form-" + candidateId;
            editFormDiv.style.display = "none";
            editFormDiv.innerHTML = `
              <input type="text" id="edit-age-${candidateId}" placeholder="Age" value="${candidate.age}" /><br>
              <input type="text" id="edit-exp-${candidateId}" placeholder="Experience" value="${candidate.experience}" /><br>
              <input type="text" id="edit-lang-${candidateId}" placeholder="Languages" value="${candidate.languages}" /><br>
              <input type="text" id="edit-skill-${candidateId}" placeholder="Skills" value="${candidate.skills}" /><br>
              <input type="text" id="edit-sec-${candidateId}" placeholder="Secretary In Charge" value="${candidate.secretaryInCharge || ''}" /><br>
              <button onclick="updateCandidate('${candidateId}', '${candidate.country}', 'normal')">Save</button>
              <button onclick="cancelEditCandidate('${candidateId}')">Cancel</button>
            `;
            candidateDiv.appendChild(editFormDiv);
          }
          candidatesListDiv.appendChild(candidateDiv);
        });
      } catch (err) {
        console.error("Error loading candidates:", err);
      }
    }
    /* Optional: Preload candidate data using the following function if your Firestore is empty.
    async function initializeCandidates() {
      const q = await getDocs(collection(db, "candidates"));
      if (q.empty) {
        // Preload sample candidates here...
      }
    }
    */
    // On DOM Content Loaded: ensure admin exists and show the login screen.
    document.addEventListener("DOMContentLoaded", async () => {
      await ensureAdminExists();
      document.getElementById("login-div").style.display = "block";
      document.getElementById("home").style.display = "none";
    });
  </script>
</body>
</html>